<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chatting</title>
</head>
<body>
<div>
    <p>대화명
    <input id="chat-id" width="20" type="text" />
    <input id="chat-connect" type="button" value="입장" />
    </p>
</div>
<div>
    <textarea id="chat-box" readonly rows="20" style="width: 100%; overflow-y: scroll; resize: none;"></textarea>
</div>
<div>
    <input id="chat-input" readonly type="text" value="" style="width: 100%;"/>
</div>
<div>
    <input id="chat-clear" type="button" value="CLEAR" />
    <input id="chat-terminate" type="button" value="TERMINATE" />
</div>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<script>
    /*
    Event struct {
        event_type  EventType
        timestamp   int         // 0 for outbound, otherwise server processed time.
        id			string      // Empty for outbound or notice inbound, otherwise user id.
        message 	string		// Content for EventType[MESSAGE].
    }
    */

    let EventType = Object.freeze({SUBSCRIBE:"SUBSCRIBE", UNSUBSCRIBE:"UNSUBSCRIBE", MESSAGE:"MESSAGE"});

    function Event(event_type, message) {
        return {
            event_type  : event_type,
            timestamp   : 0,
            id          : "",
            message     : message
        }
    }

    const client = {
        
    }

    $(document).ready(function() {
        const socket        = io();
        const chatId        = $("#chat-id");
        const chatConnect   = $("#chat-connect");
        const chatBox       = $("#chat-box");
        const chatInput     = $("#chat-input");
        const chatClear     = $("#chat-clear");
        const chatTerminate = $("#chat-terminate");

        function setLogin(enabled) {
            chatId.attr("readonly", !enabled);
            chatConnect.attr("disabled", !enabled);
        }

        function appendChatBox(text) {
            chatBox.append(text + "\n");
            chatBox.scrollTop(chatBox.prop("scrollHeight"));
            chatInput.val("");
        }

        chatInput.keydown(function (event) {
            if(event.which == 13) {
                const text=chatInput.val();
                appendChatBox("나 : \n"+text);
                socket.emit("event", Event(EventType.MESSAGE, text));
                chatInput.val("");
            }
        });

        chatConnect.click(function (event) {
            const id = chatId.val();
            if(id == "") {
                alert("사용자 아이디를 입력해주세요");
            } else {
                // 로그인 프로세스
                setLogin(false);
            }
        });

        chatClear.click(function (event){
            chatBox.text("");
        });

        chatTerminate.click(function (event) {
             fetch("http://localhost:8000/terminate");
        });

        socket.on("connect", function(event) {
            appendChatBox("채팅방에 입장하였습니다.");
        });

        socket.on("connection_error", function(err) {
            appendChatBox("채팅방에 입장하지 못했습니다.");
        });

        socket.on("disconnect", function() {
            appendChatBox("연결이 끊겼습니다.");
        });

        socket.on("event", function(event) {
            let text = ""
            switch(event.event_type) {
            case EventType.MESSAGE:
                text = event.id + " :\n" + event.message;
                break;
            case EventType.SUBSCRIBE:
                text = event.id + " 가 입장하였습니다.";
                break;
            case EventType.UNSUBSCRIBE:
                text = event.id + " 가 채팅방을 나갔습니다.";
                break;
            default:
                console.log(event.event_type + " is not implemented yet.");
            }

            if (text != "") {
                appendChatBox(text);
            }
        });
    });
</script>
</body>
</html>