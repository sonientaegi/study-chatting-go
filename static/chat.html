<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chatting</title>
</head>
<body>
<div>
    <p>대화명
    <input id="chat-username" width="20" type="text" />
    <input id="chat-connect" type="button" value="입장" />
    <input id="chat-disconnect" type="button" disabled value="나가기" />
    </p>
</div>
<div>
    <textarea id="chat-box" readonly rows="20" style="width: 100%; overflow-y: scroll; resize: none;"></textarea>
</div>
<div>
    <input id="chat-input" readonly type="text" value="" style="width: 100%;"/>
</div>
<div>
    <input id="chat-clear" type="button" value="CLEAR" />
    <input id="chat-terminate" type="button" value="TERMINATE" />
</div>
<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
<script>
    /*
    Event struct {
        event_type  EventType
        timestamp   int         // 0 for outbound, otherwise server processed time.
        username	string      // Empty for outbound or notice inbound, otherwise sender's username.
        message 	string		// Content for EventType[MESSAGE].
    }
    */
    let EventType = Object.freeze({SUBSCRIBE:"SUBSCRIBE", UNSUBSCRIBE:"UNSUBSCRIBE", MESSAGE:"MESSAGE"});

    /*
    AuthRequest struct {
        username    string
    }

    AuthResponse struct {
        isAuthenticated     bool
        reason              string  // not empty if isAuthenticated == false
    }
    */
    let AuthStatus = Object.freeze({SIGNOFF:0, SIGNIN:1, SIGNED:2});

    class SocketClient {
        constructor() {
            this.self = this;
            self.socket = io({
                autoConnect : false,
                reconnect : false
            });

            self.username = "";
            self.authStatus = AuthStatus.SIGNOFF;
            self.cbSignIn = null;
            self.cbDisconnect = null;
            self.cbEvent = null;

            self.socket.on("connect", function() {
                self.socket.emit("authRequest", {
                        username: self.username
                    },
                    function (authResponse) {
                        if (authResponse.isAuthenticated) {
                            self.authStatus = AuthStatus.SIGNED;
                        } else {
                            self.authStatus = AuthStatus.SIGNOFF;
                        }

                        if (self.cbSignIn != null) {
                            self.cbSignIn(authResponse);
                        }
                    }
                )}
            );

            self.socket.on("disconnect", function() {
                self.authStatus = AuthStatus.SIGNOFF;
                if(self.cbDisconnect != null) {
                    self.cbDisconnect();
                }
            });

            self.socket.on("event", function(event) {
                if(self.cbEvent != null) {
                    self.cbEvent(event);
                }
            });
        }

        signin(username) {
            if(self.authStatus != AuthStatus.SIGNOFF) {
                return false;
            }

            self.username = username;
            self.authStatus = AuthStatus.SIGNIN;
            self.socket.connect();
            return true;
        }

        signoff() {
            if(self.authStatus != AuthStatus.SIGNED) {
                return false;
            }

            self.socket.close();
            self.authStatus = AuthStatus.SIGNOFF;
            return true;
        }

        emitEvent(...args) {
            if(self.authStatus != AuthStatus.SIGNED) {
                return false;
            }

            return self.socket.emit("event", ...args);
        }

        onSignIn(fn) {
            self.cbSignIn = fn;
        }

        onDisconnect(fn) {
            self.cbDisconnect = fn;
        }

        onEvent(fn) {
            self.cbEvent = fn;
        }
    }

    function Event(event_type, message) {
        return {
            event_type  : event_type,
            timestamp   : 0,
            username    : "",
            message     : message
        }
    }

    $(document).ready(function() {
        const socket        = new SocketClient();
        const chatUsername  = $("#chat-username");
        const chatConnect   = $("#chat-connect");
        const chatDisconnect= $("#chat-disconnect");
        const chatBox       = $("#chat-box");
        const chatInput     = $("#chat-input");
        const chatClear     = $("#chat-clear");
        const chatTerminate = $("#chat-terminate");

        function setAuthStatus(authStatus) {
            let enableChatUsername = false;
            let enableChatConnect = false;
            let enableChatInput = false;
            let enableChatDisconnect = false;


            switch (authStatus) {
            case AuthStatus.SIGNOFF:
                enableChatUsername  = true;
                enableChatConnect   = true;
                break;
            case AuthStatus.SIGNIN:
                break;
            case AuthStatus.SIGNED:
                enableChatInput = true;
                enableChatDisconnect = true;
                break;
            }

            chatUsername.attr("readonly", !enableChatUsername);
            chatConnect.attr("disabled", !enableChatConnect);
            chatDisconnect.attr("disabled", !enableChatDisconnect);
            chatInput.attr("readonly", !enableChatInput);
        }

        function appendChatBox(text) {
            chatBox.append(text + "\n");
            chatBox.scrollTop(chatBox.prop("scrollHeight"));
            chatInput.val("");
        }

        function onSignIn(authResponse) {
            if(authResponse.isAuthenticated) {
                setAuthStatus(AuthStatus.SIGNED);
                appendChatBox("채팅방에 입장하였습니다.");
            } else {
                setAuthStatus(AuthStatus.SIGNOFF);
                appendChatBox("로그인에 실패하였습니다.");
            }
        }

        function onDisconnect() {
            setAuthStatus(AuthStatus.SIGNOFF);
            appendChatBox("서버와의 연결을 종료하였습니다.");
        }

        function onEvent(event) {
            let text = ""
            switch(event.event_type) {
                case EventType.MESSAGE:
                    text = event.username + ":\n " + event.message;
                    break;
                case EventType.SUBSCRIBE:
                    text = event.username + "가 입장하였습니다.";
                    break;
                case EventType.UNSUBSCRIBE:
                    text = event.username + "가 채팅방을 나갔습니다.";
                    break;
                default:
                    console.log(event.event_type + " is not implemented yet.");
            }

            if (text != "") {
                appendChatBox(text);
            }
        }

        socket.onSignIn(onSignIn);
        socket.onDisconnect(onDisconnect);
        socket.onEvent(onEvent);

        chatInput.keydown(function (event) {
            if(event.which == 13) {
                const text=chatInput.val();
                appendChatBox("나 : \n"+text);
                socket.emitEvent(Event(EventType.MESSAGE, text));
                chatInput.val("");
            }
        });

        chatConnect.click(function (event) {
            const username = chatUsername.val();
            if(username == "") {
                alert("사용자 아이디를 입력해주세요");
            } else {
                // 로그인 프로세스
                setAuthStatus(AuthStatus.SIGNIN);
                socket.signin(username);
            }
        });

        chatDisconnect.click(function (event) {
            chatDisconnect.attr("disabled", true);
            socket.signoff();
        });

        chatClear.click(function (event){
            chatBox.text("");
        });

        chatTerminate.click(function (event) {
             fetch("http://localhost:8000/terminate");
        });

        // Initialize
        setAuthStatus(AuthStatus.SIGNOFF);
    });
</script>
</body>
</html>